- name: Deploy via SSH
  uses: appleboy/ssh-action@v1
  with:
    host: ${{ secrets.EC2_INSTANCE_IP }}
    username: ${{ secrets.EC2_USER }}
    key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
    script: |
      # Clean up and clone fresh code
      sudo rm -rf /home/ubuntu/Astra
      mkdir -p /home/ubuntu/Astra/KYC
      cd /home/ubuntu/Astra/KYC
      git clone https://github.com/your-repo/Astra/KYC.git .

      # Set up Conda
      export PATH="$HOME/miniconda/bin:$PATH"
      eval "$(conda shell.bash hook)"
      conda init bash
      source ~/.bashrc
      conda activate kyc || (conda create -n kyc python=3.12.9 -y && conda activate kyc)

      # Install dependencies
      if [ ! -f requirements_CPU.txt ]; then
        echo "Error: requirements_CPU.txt missing!"
        exit 1
      fi
      pip install -r requirements_CPU.txt

      # Restart Uvicorn
      pkill -f "uvicorn main:app" || true
      nohup uvicorn main:app --host 0.0.0.0 --port 8080 > uvicorn.log 2>&1 &
