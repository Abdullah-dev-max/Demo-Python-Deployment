name: Python Package using Conda

on: [push]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      max-parallel: 5

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.10
      uses: actions/setup-python@v3
      with:
        python-version: '3.10'
        
    - name: Add conda to system path
      run: |
        echo $CONDA/bin >> $GITHUB_PATH
        
    - name: Install dependencies locally
      run: |
        conda env update --file environment.yml --name base

    - name: Set up SSH key
      run: |
        echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > private_key
        chmod 600 private_key

    - name: Deploy to EC2
      timeout-minutes: 10
      run: |
        ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 -i private_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_INSTANCE_IP }} << 'ENDSSH'
          set -e
          
          # Function for logging
          log() {
            echo "$(date '+%Y-%m-%d %H:%M:%S') - $1"
          }
          
          log "🚀 Starting conda deployment process..."
          log "👤 Deploying as user: $(whoami)"
          log "🖥️ Target server: ${{ secrets.EC2_INSTANCE_IP }}"
          
          # Install miniconda if not present
          if ! command -v conda &> /dev/null; then
            log "📦 Installing Miniconda..."
            wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh
            bash miniconda.sh -b -p $HOME/miniconda
            export PATH="$HOME/miniconda/bin:$PATH"
            conda init bash
            source ~/.bashrc
          else
            log "✅ Conda already installed"
          fi
          
          # Update system packages (only if needed)
          log "📦 Checking system dependencies..."
          if ! command -v tesseract &> /dev/null || ! dpkg -l | grep -q build-essential; then
            log "Installing missing system packages..."
            sudo apt-get update -qq
            sudo apt-get install -y -qq apt-utils build-essential libgl1-mesa-glx libglib2.0-0 tesseract-ocr g++
          else
            log "System dependencies already installed ✅"
          fi
          
          # Setup project directory
          log "📁 Setting up project directory..."
          cd ~ && mkdir -p Demo-Python-Deployment
          cd ~/Demo-Python-Deployment
          
          # Git operations
          log "📥 Updating code repository..."
          if [ ! -d ".git" ]; then
            git init
            git remote add origin https://github.com/Astra-Network-Organization/Demo-Python-Deployment.git
          fi
          git fetch origin main
          git reset --hard origin/main
          
          # Conda environment setup
          log "🐍 Setting up Conda environment..."
          export PATH="$HOME/miniconda/bin:$PATH"
          
          if [ -f "environment.yml" ]; then
            log "📚 Installing dependencies from environment.yml..."
            conda env update --file environment.yml --name base
          else
            log "⚠️ No environment.yml found, using pip fallback..."
            if [ -f "requirements.txt" ]; then
              pip install -r requirements.txt -q
            fi
          fi
          
          # Install additional packages
          log "📚 Installing additional packages..."
          pip install mediapipe tensorflow opencv-python fastapi qdrant-client google-cloud-vision faiss-cpu -q
          
          # Service management with health check
          log "⚙️ Managing application service..."
          sudo systemctl daemon-reload
          sudo systemctl enable fastapi-demo.service
          sudo systemctl restart fastapi-demo.service
          
          # Wait for service to start
          sleep 5
          
          # Health check
          log "🔍 Performing health check..."
          if sudo systemctl is-active --quiet fastapi-demo.service; then
            log "✅ Service is running successfully!"
          else
            log "❌ Service failed to start!"
            sudo systemctl status fastapi-demo.service --no-pager
            exit 1
          fi
          
          log "🎉 Conda deployment completed successfully!"
        ENDSSH

    - name: Verify Deployment
      timeout-minutes: 2
      run: |
        echo "🔍 Verifying deployment..."
        echo "🖥️ Server: ${{ secrets.EC2_INSTANCE_IP }}"
        echo "👤 User: ${{ secrets.EC2_USER }}"
        sleep 10

    - name: Clean up
      if: always()
      run: rm -f private_key

    - name: Deployment Success Notification
      if: success()
      run: |
        echo "🎉 Conda deployment completed successfully!"
        echo "📍 Application is running on: ${{ secrets.EC2_INSTANCE_IP }}"
        echo "👤 Deployed as user: ${{ secrets.EC2_USER }}"
        echo "⏰ Deployment time: $(date)"

    - name: Deployment Failure Notification
      if: failure()
      run: |
        echo "💥 Conda deployment failed!"
        echo "🖥️ Target server: ${{ secrets.EC2_INSTANCE_IP }}"
        echo "👤 Target user: ${{ secrets.EC2_USER }}"
        echo "🔍 Check the logs above for error details"
        echo "🕐 Failed at: $(date)"
        exit 1
