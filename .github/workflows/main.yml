name: Python Package using Conda  

on: [push]  

jobs:  
  build-and-deploy:  
    runs-on: ubuntu-latest  
    timeout-minutes: 20  
    strategy:  
      max-parallel: 5  

    env:  
      DEPLOY_DIR: /home/ubuntu/demo_python_deployment  
      EC2_INSTANCE_IP: ${{ secrets.EC2_INSTANCE_IP }}  
      EC2_SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}  
      EC2_USER: ${{ secrets.EC2_USER }}  
      APP_PORT: 8080  
      CONTAINER_NAME: python_app_container  

    steps:  
    - uses: actions/checkout@v4  

    - name: Set up Python 3.12.11  
      uses: actions/setup-python@v3  
      with:  
        python-version: '3.12.11'  

    - name: Set up SSH key  
      run: |  
        echo "$EC2_SSH_PRIVATE_KEY" > private_key  
        chmod 600 private_key  
        echo "✅ SSH key configured successfully"  

    # 1️⃣  QUICK CONNECTIVITY CHECK ------------------------------------------------  
    - name: Test EC2 Connection  
      timeout-minutes: 3  
      run: |  
        ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 -i private_key $EC2_USER@$EC2_INSTANCE_IP \
          'echo "✅ SSH OK (host: $(hostname), user: $(whoami))"'  

    # 2️⃣  PREPARE INSTANCE  -------------------------------------------------------  
    - name: Prepare Environment on EC2  
      timeout-minutes: 10  
      run: |  
        ssh -o StrictHostKeyChecking=no -o ConnectTimeout
